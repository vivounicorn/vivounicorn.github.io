<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="csXtmAKXrGoQr2GkIa90aLM9urmzXCZXGcXWMwI-kj0"><meta name="msvalidate.01" content="AF3396A141E1B198CA1BE76915B3969F"><meta name="yandex-verification" content="ee8492bd2e7708db"><meta name="baidu-site-verification" content="code-h6vqPQbqvn"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.vivounicorn.xyz",root:"/",scheme:"Muse",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"always",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:{enable:!0,onlypost:!1,loadingImg:"./images/loading.gif",isSPA:!1,preloadRatio:3},pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="本文对自动微分机器原理做了简单介绍。"><meta property="og:type" content="article"><meta property="og:title" content="机器学习中的自动微分(Automatic Differentiation)"><meta property="og:url" content="http://www.vivounicorn.xyz/article/1b1480ce.html"><meta property="og:site_name" content="业精于勤，荒于嬉；行成于思，毁于随。"><meta property="og:description" content="本文对自动微分机器原理做了简单介绍。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/bp.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/error.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/sd.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/math.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/clifford.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/fad.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/vectorad.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/bp.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/bpad.png"><meta property="og:image" content="https://vivounicorn.github.io/images/ad/rad.png"><meta property="article:published_time" content="2022-03-26T05:32:04.000Z"><meta property="article:modified_time" content="2022-09-20T05:29:18.402Z"><meta property="article:author" content="张磊"><meta property="article:tag" content="机器学习"><meta property="article:tag" content="自动微分"><meta property="article:tag" content="Automatic Differentiation"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://vivounicorn.github.io/images/ad/bp.png"><link rel="canonical" href="http://www.vivounicorn.xyz/article/1b1480ce.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>机器学习中的自动微分(Automatic Differentiation) | 业精于勤，荒于嬉；行成于思，毁于随。</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"><a target="_blank" rel="noopener" href="https://github.com/vivounicorn/" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">业精于勤，荒于嬉；行成于思，毁于随。</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">花晨月夕</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://www.vivounicorn.xyz/article/1b1480ce.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://vivounicorn.github.io/images/wali.png"><meta itemprop="name" content="张磊"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="业精于勤，荒于嬉；行成于思，毁于随。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">机器学习中的自动微分(Automatic Differentiation)</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-03-26 13:32:04" itemprop="dateCreated datePublished" datetime="2022-03-26T13:32:04+08:00">2022-03-26</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">数学</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E5%AD%A6/%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86/" itemprop="url" rel="index"><span itemprop="name">自动微分</span></a> </span></span><span id="/article/1b1480ce.html" class="post-meta-item leancloud_visitors" data-flag-title="机器学习中的自动微分(Automatic Differentiation)" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/article/1b1480ce.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/article/1b1480ce.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>34k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>31 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p><img data-src="https://vivounicorn.github.io/images/ad/bp.png" width="266"> 本文对自动微分机器原理做了简单介绍。 <span id="more"></span></p><h1 id="机器学习中的自动微分">机器学习中的自动微分</h1><p>计算机求解微分可以分成四类方法：</p><h2 id="手工求解">手工求解</h2><p>在《<a target="_blank" rel="noopener" href="https://vivounicorn.github.io/article/ad2261a2.html">机器学习与人工智能技术分享-第四章 最优化原理</a>》中介绍了大量手工求解微分的算法，它们大都是通过泰勒展开式推导出的，只利用梯度求优化问题的叫一阶优化算法，如SGD，利用Hessians矩阵求解的是二阶优化算法，如L-BFGS， 这些算法的特点是能够很灵活自主高效的求解优化问题，包括一些目标函数不可微的问题，研究人员需要有很强的数学背景和代码实现能力，缺点是耗时且容易出错，代码调试也比较复杂。</p><h2 id="数值微分">数值微分</h2><p>原理很简单，就是利用导数的定义求解，所以实现起来也不复杂，形式化描述是： 假设有<span class="math inline">\(n\)</span>元目标函数<span class="math inline">\(f(X)=f(x_1,x_2,....x_n):\mathbb{R} \rightarrow \mathbb{R}\)</span>，求解其梯度，可以对它的每个维度分别使用导数定义求解： <span class="math display">\[\frac{\partial f(X)}{\partial x_i} \approx \frac{f(X+he_i)-f(X)}{h}\]</span> 其中<span class="math inline">\(e_i\)</span>是第<span class="math inline">\(i\)</span>维的单位向量，<span class="math inline">\(0&lt;h\ll 1\)</span>是一个微小步长，最后得到： <span class="math display">\[\nabla f(X)=(\frac{\partial f}{\partial x_1},\frac{\partial f}{\partial x_2},...,\frac{\partial f}{\partial x_n})^T\]</span></p><p>例如，求解<span class="math inline">\(f(x_1,x_2)=x_1+x_2^2\)</span>，假设取<span class="math inline">\(h=0.000001\)</span>，则： <span class="math display">\[\begin{equation} \frac{\partial f(X)}{\partial x_i}\approx\left\{ \begin{aligned} \frac{f(x_1+0.000001,x_2)-f(x_1,x_2)}{0.000001}&amp;=1 \\ \frac{f(x_1,x_2+0.000001)-f(x_1,x_2)}{0.000001}&amp;=2x_2+0.000001 \end{aligned} \right. \end{equation} \]</span> 如<span class="math inline">\(f&#39;(1,1)=(1,2.000001)^T\)</span>。</p><p>不过由于这种方法的缺点是：</p><p><strong>1)</strong>、多元函数的每个维度都要算一遍，即<span class="math inline">\(O(n)\)</span>的时间复杂度，尤其在当今的机器学习问题中，这个维度非常大，会导致这种方法完全无法落地；</p><p><strong>2)</strong>、由于这种求解方法天然是病态（ill-conditioned）且不稳定的（比如计算机的计算精度本来就是有限的），所以每个维度的每个<span class="math inline">\(h\)</span>的取值要很小心，否则就会出现较大误差，这种误差一般有两种：截断误差(Truncation error)和舍入误差(Roundoff error)，</p><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Truncation_error">截断误差</a>，简单说就是因为截断操作导致的误差，例如：无穷级数: <span class="math display">\[S_n=\lim_{n \to \infty} \sum_{1}^n\frac{1}{2^n}=1\]</span> 我们只能在有限的步数内做估计，如取：<span class="math inline">\(n=6\)</span>，则<span class="math inline">\(S_6=\frac{63}{64}\)</span>，截断误差为：<span class="math inline">\(0.015625\)</span>。</p><p><a target="_blank" rel="noopener" href="https://mathworld.wolfram.com/RoundoffError.html">舍入误差</a>，简单说就是类似四舍五入这样的操作导致的误差，计算机在表示数字的能力上存在数量级和精度限制，某些数值操作对舍入误差非常敏感，且误差会被累积放大。</p><p>为了缓解上面的误差，人们想了很多办法，例如使用center difference估计法，如下： <span class="math display">\[\frac{\partial f(X)}{\partial x_i} = \frac{f(X+he_i)-f(X-he_i)}{2h}+O(h^2)\]</span></p>以函数<span class="math inline">\(f(x)=64x(1−x)(1−2x)^2(1−8x+8x^2)^2\)</span>为例，两种方法比较如下：<center><img data-src="https://vivounicorn.github.io/images/ad/error.png" width="500"></center><p>其中： <span class="math inline">\(E_{forward} (h, x_0 ) =\left|\frac{f(x_0+h)-f(x_0)}{h}-\frac{d}{dx}f(x)|_{x_0}\right|\)</span>， <span class="math inline">\(E_{center} (h, x_0 )=\left|\frac{f(x_0+h)-f(x_0-h)}{2h}-\frac{d}{dx}f(x)|_{x_0}\right|\)</span>，<span class="math inline">\(x_0=0.2\)</span> ，对截断误差和舍入误差的tradeoff体现在<span class="math inline">\(h\)</span>的取值上，即使是改进后的Center difference，稍有不慎误差也会被放大。</p><h2 id="符号微分">符号微分</h2><p>符号微分，顾名思义就是把微分的基本规则符号化，通过自动操作表达式从而获得各种衍生表达式，例如下面的积分规则： <span class="math display">\[\begin{equation} \left\{ \begin{aligned} &amp;\frac{d}{dx}(f(x)+g(x))\rightarrow\frac{d}{dx}f(x)+\frac{d}{dx}g(x) \\ &amp;\frac{d}{dx}(f(x)g(x))\rightarrow g(x)\frac{d}{dx}f(x)+f(x)\frac{d}{dx}g(x) \end{aligned} \right. \end{equation} \]</span></p><p>有了这些规则后，可以把输入变成一个由一系列符号表达式组成的树形结构，以前比较著名的深度学习框架Theano用的就是这种方式，但也正是由于这种比较“机械式”的展开，而没有通过复用和仅存储中间子表达式值的方式来简化计算，导致出现表达式成指数级膨胀。 例如函数：<span class="math inline">\(h(x) = f (x)g(x)\)</span>，对其应用导数的乘法规则有： <span class="math display">\[ \frac{d}{dx}h(x)= g(x)\frac{d}{dx}f(x)+f(x)\frac{d}{dx}g(x) \]</span> 这个式子中，<span class="math inline">\(g(x)\)</span>与<span class="math inline">\(\frac{d}{dx}g(x)\)</span>是相互独立各算各的，显然一个不小心，它们的公用部分就无法复用，随便一个例子：<span class="math inline">\(g(x)=6+e^x\)</span>，<span class="math inline">\(\frac{d}{dx}g(x)=e^x\)</span>，公共部分重复计算。</p>如果我们更关心输入函数的导数能否准确被算出，而不是它的符号表达本身的话，是可以通过复用及仅存储中间子表达式值的方式来简化计算的，这种思想也是自动微分的基础之一，如下图的例子，对函数<span class="math inline">\(l_{n+1} = 4l_n (1 − l_n ), l_1 = x\)</span>做表达式展开：<center><img data-src="https://vivounicorn.github.io/images/ad/sd.png" width="600"></center><p>其中第三列是以符号微分形式展开，显然随着式子复杂度上升，展开式复杂度急剧上升，第四列是中间字表达式简化后的形式，复杂度比原始形式大大下降。</p><h2 id="自动微分ad">自动微分(AD)</h2><p>通过定义一个有限基本运算的集合，这些基本运算的求导数方法已知，包括一元运算（如：负数、开根号等）、二元运算（如：加、减、乘、除等）、超越函数（如：指数函数、三角函数、反三角函数、对数函数等），利用链式法则结合这些基本运算的导数，通过延迟 计算的方式来计算整个函数的导数，相比符号微分等其他方法，不但能处理封闭表达式（closed-form expressions），还可以支持控制流，如分支、循环、递归和过程调用等，这里解释下什么叫封闭表达式。</p><h3 id="封闭表达式closed-form-expressions">封闭表达式(Closed-Form Expressions)</h3><p>简单说就是能用固定数量操作符表达的式子。</p><p>例如：<span class="math inline">\(y=2+4+6+...+2n\)</span>不是封闭表达式，而<span class="math inline">\(y=\sum\limits_{i=1}^{n}2i=n(n+1)\)</span>就是封闭表达式。常见的封闭形式举例： <span class="math display">\[ \begin{aligned} &amp; \sum\limits_{i=m}^{n}c=(n - m +1)c\\ &amp; \sum\limits_{i=1}^{n}i=\frac{n(n+1)}{2}\\ &amp; \sum\limits_{i=1}^{n}i^2=\frac{n(n+1)(2n+1)}{6}\\ &amp; \sum\limits_{i=0}^{n}a^i=\frac{a^{n+1}-1}{a-1}(a\neq1)\\ &amp; \sum\limits_{i=1}^{n}ia^i=\frac{a-(n+1)a^{n+1}+na^{n+2}}{(a-1)^2}\\ \end{aligned} \]</span></p><p>问题：找到<span class="math inline">\(2 + 2^2 \cdot 7 + 2^3 \cdot 14 +...+ 2^n (n-1)\cdot 7\)</span>的封闭形式。 解： <span class="math display">\[ \begin{aligned} y=&amp; 2 + 2^2 \cdot 7 + 2^3 \cdot 14 +...+ 2^n (n-1)\cdot 7\\ =&amp; 2+\sum\limits_{i=2}^{n}2^i(i-1)\cdot 7\\ =&amp; 2+7\sum\limits_{i=2}^{n}(i-1)2^i\\ =&amp; 2+7\sum\limits_{i=1}^{n-1}i2^{i+1}\\ =&amp; 2+14\sum\limits_{i=1}^{n-1}i2^i\\ =&amp; 2+14(2-n2^n+(n-1)2^{n+1}) \end{aligned} \]</span></p><h3 id="对偶数">对偶数</h3>数学本质上是由人类通过逻辑抽象思维对事物主观定义出结构和模式并以工具形式存在，用于解决实际问题的。而抽象逻辑是需要自洽的，所以在不同应用范围会产生递进的不同工具：<center><img data-src="https://vivounicorn.github.io/images/ad/math.png" width="600"></center><p>例如，复数定义为： <span class="math display">\[z=a+bi\]</span> 其中<span class="math inline">\(a\)</span>和<span class="math inline">\(b\)</span>都是实数且<span class="math inline">\(i^2=1\)</span>，复数在实际中有广泛的应用。(ps：我最喜欢欧拉公式：<span class="math inline">\(e^{ix}=\cos x+i\sin x\)</span>，尤其当<span class="math inline">\(x=\pi\)</span>时，<span class="math inline">\(e^{i\pi}+1=0\)</span>)</p><p>类似复数，在19世纪后期，W. Clifford定义和发展出了对偶数，即： <span class="math display">\[z=a+b\epsilon\]</span> 其中<span class="math inline">\(a\)</span>和<span class="math inline">\(b\)</span>都是实数且<span class="math inline">\(\epsilon^2=0\)</span>。</p><center><img data-src="https://vivounicorn.github.io/images/ad/clifford.png" width="300"></center><p>那么对偶数有什么用呢？看到这个定义，我第一个想到的是微分定义中的无穷小量<span class="math inline">\(dx\)</span>，第二个想到的是，函数的泰勒展开式的2阶及以上的余项部分。 假设<span class="math inline">\(f:\mathbb{R} \rightarrow \mathbb{R}\)</span>是任意函数，那么在<span class="math inline">\(x+\epsilon\)</span>处做泰勒展开，如下： <span class="math display">\[ f(x+\epsilon)=f(x)+f&#39;(x)\epsilon+ O(\epsilon^2) \]</span> 其中<span class="math inline">\(O(\epsilon^2) \rightarrow0\)</span>。显然<span class="math inline">\(f(x)+f&#39;(x)\epsilon\)</span>就是个对偶数，所以有对偶函数： <span class="math display">\[ \hat f(\hat x)=f(x)+f&#39;(x)\epsilon \]</span> 简化表示为： <span class="math display">\[ \hat f(\hat x)=\{f_0,f_1\},\text{where } f_0=f(x) \text{ and }f_1=f&#39;(x). \]</span> 对复合函数<span class="math inline">\(f(g(x))\)</span>，根据链式法则有：<span class="math inline">\((f(g(x)))&#39;=f&#39;(g(x))g&#39;(x)\)</span>有： <span class="math display">\[ \hat f(\hat g)=f(g(x))+(f(g(x)))&#39;\epsilon=f(g(x))+f&#39;(g(x))g&#39;(x)\epsilon \]</span> 简写为： <span class="math display">\[ \hat f(\hat g)=\{f_0(g_0),f_1(g_0)g_1\} \]</span> 对更复杂的函数<span class="math inline">\(h(x)=f(g(u(x)))\)</span>有 <span class="math display">\[ \hat f(\hat g(\hat u))=\{f_0(g_0(u_0)),f_1(g_0(u_0))g_1(u_0)u_1\} \]</span> 也就是只需要执行一次链式求导就能直接求出<span class="math inline">\(h&#39;(x)\)</span>（隐含链式求导是延迟执行的），这就是利用对偶数求解某个函数导数的威力，这个就是自动微分前向模式(Forward Mode of AD)的理论依据。</p><p>再进一步，定义新的对偶数： <span class="math display">\[ \widetilde r=a+b\epsilon_1+c\epsilon_2, \widetilde r=\{a,b,c\} \]</span> 其中<span class="math inline">\(\{a,b,c\}\in \mathbb{R}\)</span>，<span class="math inline">\(i,j\in\{1,2\}\)</span>满足关系： <span class="math display">\[ \begin{equation} \epsilon_i\cdot \epsilon_j=\left\{ \begin{aligned} &amp;0&amp;\text{ if }i+j&gt;2, \\ &amp;2\epsilon_{i+j}&amp;\text{ otherwise.} \end{aligned} \right. \end{equation} \]</span> 把泰勒展开式展开到二阶： <span class="math display">\[ \begin{aligned} f(\widetilde x)=&amp;f(x)+f&#39;(x)\epsilon_1+\frac{1}{2}f&#39;&#39;(x)\epsilon_1^2\\ =&amp;f(x)+f&#39;(x)\epsilon_1+f&#39;&#39;(x)\epsilon_2 \end{aligned} \]</span> 简写为： <span class="math display">\[ \begin{aligned} \widetilde f(\widetilde x)=&amp;\{f(x),f&#39;(x),f&#39;&#39;(x)\}\\ =&amp;\{f_0,f_1,f_2\} \end{aligned} \]</span></p><p>以矩阵形式看，定义： <span class="math display">\[ \begin{aligned} I=&amp;\left[ \begin{matrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{matrix} \right]\\ \epsilon_1=&amp;\left[ \begin{matrix} 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \\ 0 &amp; 0 &amp; 0 \end{matrix} \right]\\ \epsilon_2=&amp;\left[ \begin{matrix} 0 &amp; 0 &amp; 1/2 \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 \end{matrix} \right]\\ \end{aligned} \]</span> <span class="math inline">\(X=xI+\epsilon_1\)</span>，则： <span class="math display">\[ f(X)=f(x)I+f&#39;(x)\epsilon_1+f&#39;&#39;(x)\epsilon_2 \]</span> 同样有： <span class="math display">\[ \widetilde f(\widetilde x)=\{f_0,f_1,f_2\},\text{ and }f_0=f(x),f_1=f&#39;(x),f_2=f&#39;&#39;(x). \]</span> 对复合函数<span class="math inline">\(f(g(x))\)</span>就有： <span class="math display">\[ \widetilde f(\widetilde g)=\{f_0(g_0),f_1(g_0)g_1,f_2(g_0)g_1^2+f_1(g_0)g_2\}. \]</span> 这个式子最核心的价值除了前面说的<strong>只需要执行一次链式求导就能直接求出目标函数的导数（这个导数就是对偶数的第二/对偶部分）</strong>外，导数结果<strong>不存在截断误差和舍入误差</strong>。</p><p>常用的对偶数推论有： <span class="math display">\[ \begin{aligned} 1.&amp;(a+b \epsilon)+(c+d \epsilon)=a+c+(b+d)\epsilon\\ 2.&amp;(a+b \epsilon)\cdot(c+d \epsilon)=ac+(ad+bc)\epsilon\\ 3.&amp;\frac{a+b \epsilon}{c+d \epsilon}=\frac{a}{c}+\frac{bc-ad}{c^2}\epsilon\\ 4.&amp;-(a+b \epsilon)=-a-b\epsilon\\ 5.&amp;P(a) = p_0 + p_1a + p_2a^2 + · · · + p_na^n \text{ 在}a+b\epsilon\text{处对偶形式为}p(a+b\epsilon)=p(a)+p&#39;(a)b\epsilon\\ 6.&amp;sin(a+b\epsilon )=sin(a)+cos(a)b\epsilon\\ 7.&amp;cos(a+b\epsilon )=cos(a)-sin(a)b\epsilon\\ 8.&amp;e^{a+b\epsilon}=e^a+be^a\epsilon\\ 9.&amp;log(a+b\epsilon)=log(a)+\frac{b}{a}\epsilon \text{ and }a\neq 0\\ 10.&amp;\sqrt{a+b\epsilon}=\sqrt{a}+\frac{b}{2\sqrt{a}}\epsilon \text{ and }a\neq 0\\ 11.&amp;(a+b\epsilon)^n=a^n+na^{n-1}b\epsilon\\ \end{aligned} \]</span></p><p>举个例子：求函数<span class="math inline">\(f(x)=x-e^{-sin(x)}\)</span>的导数<span class="math inline">\(f&#39;(x)\)</span>，有： <span class="math display">\[ \begin{aligned} f(x+\epsilon)&amp;=x+\epsilon-e^{-sin(x+\epsilon)}\\ &amp;=x+\epsilon-e^{-(sin(x)+cos(x)\epsilon)}\\ &amp;=x-e^{-sin(x)}+(1+cos(x)\cdot e^{-sin(x)})\epsilon \end{aligned} \]</span> 即：<span class="math inline">\(\widetilde f(\widetilde x)=\{x-e^{-sin(x)},1+cos(x)\cdot e^{-sin(x)}\}\)</span> 所以可以取出对偶部，直接得到<span class="math inline">\(f&#39;(x)=1+cos(x)\cdot e^{-sin(x)}\)</span>。</p><h3 id="前向模式自动微分forward-mode-ad">前向模式自动微分(Forward mode AD)</h3><p>前向模式的自动微分等价于执行基于对偶数的函数，举个例子，求函数<span class="math inline">\(f(x)=x\sin(x^2)\)</span>在点<span class="math inline">\(x=6\)</span>处的导数：</p><table><thead><tr class="header"><th>原始问题</th><th style="text-align:left">前向模式</th></tr></thead><tbody><tr class="odd"><td><span class="math inline">\(w_1=x\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{w_1}=1\)</span></td></tr><tr class="even"><td><span class="math inline">\(w_2=w_1^2\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{w_2}=2w_1\dot{w_1}=2x\)</span></td></tr><tr class="odd"><td><span class="math inline">\(w_3=\sin(w_2)\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{w_3}=\cos(w_2)\dot{w_2}=2x\cos(x^2)\)</span></td></tr><tr class="even"><td><span class="math inline">\(w_4=w_1w_3\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{w_1}w_3+w_1\dot{w_3}=\sin(x^2)+2x^2\cos(x^2)\)</span></td></tr></tbody></table>计算图如下：<center><img data-src="https://vivounicorn.github.io/images/ad/fad.png" width="400"></center><p>所以在<span class="math inline">\(x=6\)</span>处原函数的导数为：<span class="math inline">\(f&#39;(6)=\sin(36)+52\cos(36)=-10.205\)</span>，用对偶数推导如下： <span class="math display">\[ \begin{aligned} \text{set}&amp;\\ x&amp;=6+\epsilon \\ u&amp;=x^2\\ &amp;=(6+\epsilon)^2\\ &amp;=36+12\epsilon\\ \text{then}&amp;\\ v&amp;=\sin(u)\\ &amp;=\sin(36+12\epsilon)\\ &amp;=\sin(36)+12\cos(36)\epsilon\\ \text{finally}&amp;\\ w&amp;=x\sin(v)\\ &amp;=(6+\epsilon)(\sin(36)+12\cos(36)\epsilon)\\ &amp;=6\sin(36)+(\sin(36)+72\cos(36))\epsilon \end{aligned} \]</span> 所以利用对偶数同时求得：<span class="math inline">\(f(6)=6\sin(36)=-5.95\)</span>和<span class="math inline">\(f&#39;(6)=\sin(36)+72\cos(36)=-10.205\)</span>。</p><p>多元函数的例子，计算函数<span class="math inline">\(f(x,y,z)=xy\cos(xz)\)</span>在点<span class="math inline">\((-2,3,-6)\)</span>处的梯度向量：</p><table><colgroup><col style="width:22%"><col style="width:77%"></colgroup><thead><tr class="header"><th>原始问题</th><th style="text-align:left">前向模式</th></tr></thead><tbody><tr class="odd"><td><span class="math inline">\(t=xy\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{t}=[y,x,0]\)</span></td></tr><tr class="even"><td><span class="math inline">\(u=xz\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{u}=[z,0,x]\)</span></td></tr><tr class="odd"><td><span class="math inline">\(v=\cos(u)\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{v}=-\sin(u)\dot{u}=[-\sin(xz)z,0,-\sin(xz)x]\)</span></td></tr><tr class="even"><td><span class="math inline">\(w=tv\)</span></td><td style="text-align:left"><span class="math inline">\(\dot{w}=\dot{t}v+t\dot{v}=[y\cos(xz)-xyz\sin(xz),x\cos(xz),-x^2y\sin(xz)]\)</span></td></tr></tbody></table>计算图如下：<center><img data-src="https://vivounicorn.github.io/images/ad/vectorad.png" width="400"></center><p>利用对偶数原理和one-hot方式表示，有： <span class="math display">\[ \begin{aligned} \text{set}&amp;\\ x&amp;=-2+\epsilon[1,0,0] \\ y&amp;=3+\epsilon[0,1,0]\\ z&amp;=-6+\epsilon[0,0,1]\\ \text{then}&amp;\\ t&amp;=xy\\ &amp;=(-2+\epsilon[1,0,0])(3+\epsilon[0,1,0])\\ &amp;=-6+\epsilon[3,-2,0]\\ u&amp;=xz\\ &amp;=(-2+\epsilon[1,0,0])(-6+\epsilon[0,0,1])\\ &amp;=12+\epsilon[-6,0,-2]\\ v&amp;=\cos(u)\\ &amp;=\cos(12+\epsilon[-6,0,-2])\\ &amp;=\cos(12)-\epsilon\sin(12)[-6,0,-2]\\ w&amp;=tv\\ &amp;=(-6+\epsilon[3,-2,0])(\cos(12)-\epsilon\sin(12)[-6,0,-2])\\ &amp;=-6\cos(12)+\epsilon[-36\sin(12)+3\cos(12),-2\cos(12),-12\sin(12)]\\ &amp;=-5.063+\epsilon[21.848, -1.688, 6.439] \end{aligned} \]</span></p><p>所以利用对偶数同时求得：<span class="math inline">\(f(-2,3,-6)=-5.063\)</span>和<span class="math inline">\(\bigtriangledown f(-2,3,-6)=[21.848, -1.688, 6.439]\)</span>。</p><h3 id="前向ad代码实践">前向AD代码实践</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">from</span> deprecated.sphinx <span class="keyword">import</span> deprecated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dual</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    封装对偶数及其常用操作符.</span></span><br><span class="line"><span class="string">    Wraps dual number and its common operators.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, f0, f1=<span class="number">0.0</span>, var_name=<span class="string">&#x27;x&#x27;</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化对偶数.</span></span><br><span class="line"><span class="string">        :param f0: 对偶数函数值部分.</span></span><br><span class="line"><span class="string">        :param f1: 对偶数一阶导数部分.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.f0 = f0</span><br><span class="line">        self.f1 = f1</span><br><span class="line">        self.var_name = var_name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数正向加法操作.</span></span><br><span class="line"><span class="string">        :param obj: 加数.</span></span><br><span class="line"><span class="string">        :return: 加和结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 + obj.f0, self.f1 + obj.f1)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 + obj, self.f1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__radd__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数反向加法操作.</span></span><br><span class="line"><span class="string">        :param obj: 被加数.</span></span><br><span class="line"><span class="string">        :return: 加和结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 + obj.f0, self.f1 + obj.f1)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 + obj, self.f1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数正向减法操作.</span></span><br><span class="line"><span class="string">        :param obj: 减数.</span></span><br><span class="line"><span class="string">        :return: 减法结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 - obj.f0, self.f1 - obj.f1)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 - obj, self.f1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rsub__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数反向减法操作.</span></span><br><span class="line"><span class="string">        :param obj: 被减数.</span></span><br><span class="line"><span class="string">        :return: 减法结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual):</span><br><span class="line">            <span class="keyword">return</span> Dual(obj.f0 - self.f0, obj.f1 - self.f1)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(obj - self.f0, -self.f1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__mul__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数正向乘法操作.</span></span><br><span class="line"><span class="string">        :param obj: 乘数.</span></span><br><span class="line"><span class="string">        :return: 乘法结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 * obj.f0, self.f0 * obj.f1 + self.f1 * obj.f0)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 * obj, self.f1 * obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rmul__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数逆向乘法操作.</span></span><br><span class="line"><span class="string">        :param obj: 被乘数.</span></span><br><span class="line"><span class="string">        :return: 乘法结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 * obj.f0, self.f0 * obj.f1 + self.f1 * obj.f0)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 * obj, self.f1 * obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__truediv__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数正向除法操作.</span></span><br><span class="line"><span class="string">        :param obj: 除数.</span></span><br><span class="line"><span class="string">        :return: 除法结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual) <span class="keyword">and</span> obj.f0 != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 / obj.f0, (self.f1 * obj.f0 - self.f0 * obj.f1) / obj.f0 ** <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>) <span class="keyword">and</span> obj != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 / obj, self.f1 / obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rtruediv__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数反向除法操作，obj若为整数或浮点数会被自动转为对偶数.</span></span><br><span class="line"><span class="string">        :param obj: 被除数.</span></span><br><span class="line"><span class="string">        :return: 除法结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Dual) <span class="keyword">and</span> self.f0 != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> Dual(obj.f0 / self.f0, (obj.f1 * self.f0 - obj.f0 * self.f1) / self.f0 ** <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">float</span>) <span class="keyword">and</span> self.f0 != <span class="number">0</span>:</span><br><span class="line">            obj = Dual(obj)</span><br><span class="line">            <span class="keyword">return</span> Dual(obj.f0 / self.f0, (obj.f1 * self.f0 - obj.f0 * self.f1) / self.f0 ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__neg__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数取负数操作.</span></span><br><span class="line"><span class="string">        :return: 取负结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Dual(-self.f0, -self.f1)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__pow__</span>(<span class="params">self, n</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数幂函数操作，要求n必须为整数.</span></span><br><span class="line"><span class="string">        :param n: 幂.</span></span><br><span class="line"><span class="string">        :return: 幂函数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(n, <span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(self.f0 ** n, n * self.f0 ** (n - <span class="number">1</span>) * self.f1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        重载对偶数字符串函数.</span></span><br><span class="line"><span class="string">        :return: 对偶数的格式化字符串.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.f1 &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#123;&#125; = &#123;&#125; + &#123;&#125; ε&#x27;</span>.<span class="built_in">format</span>(self.var_name, self.f0, self.f1)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#123;&#125; = &#123;&#125; - &#123;&#125; ε&#x27;</span>.<span class="built_in">format</span>(self.var_name, self.f0, math.fabs(self.f1))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_dual</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        格式化打印对偶数.</span></span><br><span class="line"><span class="string">        :return: 控制台输出.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(self)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sin</span>(<span class="params">x</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对偶数sine函数.</span></span><br><span class="line"><span class="string">        :param x: 输入变量.</span></span><br><span class="line"><span class="string">        :return: 对偶数形式的函数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> Dual:</span><br><span class="line">            <span class="keyword">return</span> Dual(math.sin(x.f0), math.cos(x.f0) * x.f1)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(x, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(x, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(math.sin(x))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cos</span>(<span class="params">x</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对偶数cosine函数.</span></span><br><span class="line"><span class="string">        :param x: 输入变量.</span></span><br><span class="line"><span class="string">        :return: 对偶数形式的函数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> Dual:</span><br><span class="line">            <span class="keyword">return</span> Dual(math.cos(x.f0), -math.sin(x.f0) * x.f1)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(x, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(x, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(math.cos(x))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">x</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对偶数e^x函数.</span></span><br><span class="line"><span class="string">        :param x: 输入变量.</span></span><br><span class="line"><span class="string">        :return: 对偶数形式的函数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> Dual:</span><br><span class="line">            <span class="keyword">return</span> Dual(math.exp(x.f0), math.exp(x.f0) * x.f1)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(x, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(x, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(math.exp(x))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">x</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对偶数log函数.</span></span><br><span class="line"><span class="string">        :param x: 输入变量.</span></span><br><span class="line"><span class="string">        :return: 对偶数形式的函数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> Dual <span class="keyword">and</span> x.f0 != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> Dual(math.log(x.f0), x.f1 / x.f0)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(x, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(x, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(math.log(x))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sqrt</span>(<span class="params">x</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        对偶数开根号函数.</span></span><br><span class="line"><span class="string">        :param x: 输入变量.</span></span><br><span class="line"><span class="string">        :return: 对偶数形式的函数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> Dual:</span><br><span class="line">            <span class="keyword">return</span> Dual(math.sqrt(x.f0), x.f1 / (<span class="number">2</span> * math.sqrt(x.f0)))</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(x, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(x, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Dual(math.sqrt(x))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @deprecated(<span class="params">version=<span class="string">&#x27;1.0&#x27;</span>, reason=<span class="string">&quot;This function will be removed soon.&quot;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">derive</span>(<span class="params">func, f1=<span class="number">1</span>, *args</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        求函数一阶导数.</span></span><br><span class="line"><span class="string">        :param func: 待求解函数.</span></span><br><span class="line"><span class="string">        :param f1: 函数一阶导数初始化.</span></span><br><span class="line"><span class="string">        :param args: 函数参数.</span></span><br><span class="line"><span class="string">        :return: 一阶导数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        paras = []</span><br><span class="line">        <span class="keyword">for</span> para <span class="keyword">in</span> args:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(para, Dual):</span><br><span class="line">                paras.append(Dual(para, f1))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                paras.append(para)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(paras) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> func(paras[<span class="number">0</span>]).f1</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(paras) == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> func(paras[<span class="number">0</span>], paras[<span class="number">1</span>]).f1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">func, *args</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        求解指定多元函数的梯度，依据从左到右的变量顺序给出梯度值，</span></span><br><span class="line"><span class="string">        例如：函数 f(x,y)的梯度为：▽f(x,y)=[f&#x27;(x),f&#x27;(y)].</span></span><br><span class="line"><span class="string">        :param func: 待求解函数.</span></span><br><span class="line"><span class="string">        :param args: 函数输入参数.</span></span><br><span class="line"><span class="string">        :return: 梯度向量.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        gs = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(args)):</span><br><span class="line">            paras = []</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(args)):</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(args[j], Dual):</span><br><span class="line">                    <span class="keyword">if</span> i == j:</span><br><span class="line">                        paras.append(Dual(args[j], <span class="number">1</span>))</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        paras.append(Dual(args[j], <span class="number">0</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span> i == j:</span><br><span class="line">                        paras.append(Dual(args[j].f0, <span class="number">1</span>))</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        paras.append(Dual(args[j].f0, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">            gs.append(func(paras).f1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> gs</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">newton_raphson</span>(<span class="params">func, x0, u0, n</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        二元函数牛顿-拉森夫法.</span></span><br><span class="line"><span class="string">        :param func: 待求解函数.</span></span><br><span class="line"><span class="string">        :param x0: 输入变量1.</span></span><br><span class="line"><span class="string">        :param u0: 输入变量2.</span></span><br><span class="line"><span class="string">        :param n: 算法迭代次数.</span></span><br><span class="line"><span class="string">        :return: 对偶数结果.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        x0d = Dual(x0, <span class="number">1</span>)</span><br><span class="line">        u0d = Dual(u0)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            fx = func(u0d, x0d)</span><br><span class="line">            fu = Dual.gradient(func, Dual(u0d.f0, <span class="number">1</span>), x0d)</span><br><span class="line">            u0d = u0d - fx / fu[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;k=&#123;&#125;, &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(k, u0d))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> u0d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">excf1</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    复合函数示例：f(u(x),x) = cos(u(x)x)−u(x)^3+x+ sin(u(x)^2x)</span></span><br><span class="line"><span class="string">    :param args: 输入参数(u(x),x).</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(args[<span class="number">0</span>]) == <span class="number">2</span>:</span><br><span class="line">        u = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        x = args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        u = args[<span class="number">0</span>]</span><br><span class="line">        x = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Dual.cos(u * x) - u ** <span class="number">3</span> + x + Dual.sin(u ** <span class="number">2</span> * x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">excf2</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    示例函数：f(u(x),x) = sin(u(x))+x</span></span><br><span class="line"><span class="string">    :param args: 输入参数(u(x),x).</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(args[<span class="number">0</span>]) == <span class="number">2</span>:</span><br><span class="line">        u = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        x = args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        u = args[<span class="number">0</span>]</span><br><span class="line">        x = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Dual.sin(u) + x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exf0</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    示例函数：f(x) = 6x^3 + 2x^2.</span></span><br><span class="line"><span class="string">    :param args: 输入参数x.</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">1</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(args[<span class="number">0</span>], <span class="built_in">list</span>):</span><br><span class="line">        x = args[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        x = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">6</span> * x ** <span class="number">3</span> + <span class="number">2</span> * x ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dexf0</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    一元函数示例：f(x) = 6x^3 + 2x^2的梯度值.</span></span><br><span class="line"><span class="string">    :param x: 输入参数(x).</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> Dual.gradient(exf0, x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exf1</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    二元函数示例：f(x) = 3x+10y的梯度向量.</span></span><br><span class="line"><span class="string">    :param x: 输入参数(x,y).</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    x = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    y = args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span> * x + <span class="number">10</span> * y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exf2</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    三元函数示例：f(x,y,z)=xysin(yz)的梯度向量.</span></span><br><span class="line"><span class="string">    :param args: 输入参数(x,y,z)</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    x = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    y = args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    z = args[<span class="number">0</span>][<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">return</span> x * y * Dual.sin(y * z)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exf3</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    二元函数示例：f(x1,x2)=log(x1)+x1*x2-sin(x2)的梯度向量.</span></span><br><span class="line"><span class="string">    :param args: 输入参数(x,y,z)</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    x1 = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    x2 = args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> Dual.log(x1) + x1 * x2 - Dual.sin(x2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exfox</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    二元函数示例：f(x1,x2)=log(x1)+x1*x2-sin(x2)的梯度向量.</span></span><br><span class="line"><span class="string">    :param args: 输入参数(x,y,z)</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    x1 = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    x2 = args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> x1 * x2 + Dual.sin(x1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exfams</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    二元函数示例：f(x1,x2)=log(x1)+x1*x2-sin(x2)的梯度向量.</span></span><br><span class="line"><span class="string">    :param args: 输入参数(x,y,z)</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">1</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(args[<span class="number">0</span>], <span class="built_in">list</span>):</span><br><span class="line">        x = args[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        x = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> x * Dual.sin(x ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exf5</span>(<span class="params">*args</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    三元函数示例：f(x,y,z)=xycos(xz)的梯度向量.</span></span><br><span class="line"><span class="string">    :param args: 输入参数(x,y,z)</span></span><br><span class="line"><span class="string">    :return: 对偶数结果.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    x = args[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    y = args[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    z = args[<span class="number">0</span>][<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">return</span> x * y * Dual.cos(x * z)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    x0 = <span class="number">0.7</span></span><br><span class="line">    u0 = <span class="number">1.6</span></span><br><span class="line">    n = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    u = Dual.newton_raphson(excf1, x0, u0, n)</span><br><span class="line">    u.print_dual()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[31mf(u(x),x) = cos(u(x)x)−u(x)^3+x+ sin(u(x)^2x) use the newton-raphson algorithm to find u(x) at the &quot;</span></span><br><span class="line">          <span class="string">&quot;initial value (x0,u0)=(&#123;&#125;, &#123;&#125;): \033[0m&quot;</span>.<span class="built_in">format</span>(x0, u0))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[31mu(x0)=&#123;&#125; and u&#x27;(x0)=&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(u.f0, u.f1))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[32mf(u(x),x) = sin(u(x))+x at the &quot;</span></span><br><span class="line">          <span class="string">&quot;initial value (x0,u0)=(&#123;&#125;, &#123;&#125;): \033[0m&quot;</span>.<span class="built_in">format</span>(x0, u0))</span><br><span class="line">    g = excf2(u, x0) + Dual(<span class="number">0</span>, Dual.gradient(excf2, u, x0)[<span class="number">1</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[32mg(x0)=&#123;&#125; and g&#x27;(x0)=&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(g.f0, g.f1))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[33mf(x) = 6x^3 + 2x^2: f(1) = &#123;&#125; then f&#x27;(1) = &#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(exf0(<span class="number">1</span>), dexf0(<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[31mf(x,y) =3x + 10y gradient vector at point(&#123;&#125;,&#123;&#125;):&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(<span class="number">1</span>, <span class="number">1</span>, Dual.gradient(exf1, <span class="number">1</span>, <span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[32mf(x,y,z) =xysin(yz) gradient vector at point(&#123;&#125;,&#123;&#125;,&#123;&#125;):&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(<span class="number">3</span>, -<span class="number">1</span>, <span class="number">2</span>,</span><br><span class="line">                                                                                            Dual.gradient(exf2, <span class="number">3</span>, -<span class="number">1</span>,</span><br><span class="line">                                                                                                          <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[32mf(x,y,z) =xycos(xz) gradient vector at point(&#123;&#125;,&#123;&#125;,&#123;&#125;):&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(-<span class="number">2</span>, <span class="number">3</span>, -<span class="number">6</span>,</span><br><span class="line">                                                                                             Dual.gradient(exf5, -<span class="number">2</span>, <span class="number">3</span>,</span><br><span class="line">                                                                                                           -<span class="number">6</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[33mf(x1,x2)=log(x1)+x1*x2-sin(x2) gradient vector at point(&#123;&#125;,&#123;&#125;):&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(<span class="number">2</span>, <span class="number">5</span>,</span><br><span class="line">                                                                                                    Dual.gradient(exf3,</span><br><span class="line">                                                                                                                  <span class="number">2</span>,</span><br><span class="line">                                                                                                                  <span class="number">5</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[33mf(x1,x2)=x1*x2+sin(x1) gradient vector at point(&#123;&#125;,&#123;&#125;):&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(<span class="number">2</span>, <span class="number">5</span>,</span><br><span class="line">                                                                                            Dual.gradient(exfox,</span><br><span class="line">                                                                                                          <span class="number">2</span>,</span><br><span class="line">                                                                                                          <span class="number">5</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\033[33mf(x)=xsin(x**2) gradient vector at point(&#123;&#125;):&#123;&#125;\033[0m&quot;</span>.<span class="built_in">format</span>(<span class="number">6</span>,</span><br><span class="line">                                                                                  Dual.gradient(exfams,</span><br><span class="line">                                                                                                <span class="number">6</span>)))</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">k=0, x = 1.3745071326929446 - 0.11382505528565992 ε</span><br><span class="line">k=1, x = 1.3128464318221855 + 0.058350216540021926 ε</span><br><span class="line">k=2, x = 1.3085520610889037 + 0.11245296805019295 ε</span><br><span class="line">k=3, x = 1.3085322280402245 + 0.11635228047793793 ε</span><br><span class="line">k=4, x = 1.3085322276188782 + 0.11637033108795897 ε</span><br><span class="line">k=5, x = 1.3085322276188782 + 0.11637033147144211 ε</span><br><span class="line">k=6, x = 1.3085322276188782 + 0.11637033147144209 ε</span><br><span class="line">k=7, x = 1.3085322276188782 + 0.11637033147144213 ε</span><br><span class="line">k=8, x = 1.3085322276188782 + 0.1163703314714421 ε</span><br><span class="line">k=9, x = 1.3085322276188782 + 0.1163703314714421 ε</span><br><span class="line">x = 1.3085322276188782 + 0.1163703314714421 ε</span><br><span class="line">f(u(x),x) = cos(u(x)x)−u(x)^3+x+ sin(u(x)^2x) use the newton-raphson algorithm to find u(x) at the initial value (x0,u0)=(0.7, 1.6):</span><br><span class="line">u(x0)=1.3085322276188782 and u&#x27;(x0)=0.1163703314714421</span><br><span class="line">f(u(x),x) = sin(u(x))+x at the initial value (x0,u0)=(0.7, 1.6):</span><br><span class="line">g(x0)=1.6658054458395304 and g&#x27;(x0)=1.0301710907484147</span><br><span class="line">f(x) = 6x^3 + 2x^2: f(1) = 8 then f&#x27;(1) = [22]</span><br><span class="line">f(x,y) =3x + 10y gradient vector at point(1,1):[3, 10]</span><br><span class="line">f(x,y,z) =xysin(yz) gradient vector at point(3,-1,2):[0.9092974268256817, -0.23101126119419035, -1.2484405096414273]</span><br><span class="line">f(x,y,z) =xycos(xz) gradient vector at point(-2,3,-6):[21.848186924213135, -1.6877079174649843, 6.43887501600522]</span><br><span class="line">f(x1,x2)=log(x1)+x1*x2-sin(x2) gradient vector at point(2,5):[5.5, 1.7163378145367738]</span><br><span class="line">f(x1,x2)=x1*x2+sin(x1) gradient vector at point(2,5):[4.583853163452858, 2.0]</span><br><span class="line">f(x)=xsin(x**2) gradient vector at point(6):[-10.205164506616253]</span><br></pre></td></tr></table></figure><h3 id="反向模式自动微分reverse-mode-ad">反向模式自动微分(Reverse mode AD)</h3>反向模式的自动微分等价于广义上的反向传播算法(BP)，都是从输出反向传播梯度，并用 <strong>伴随变量</strong> <span class="math inline">\(\overline{v}_i=\frac{\partial{y_j}}{\partial v_i}\)</span>补全中间变量， 即，反向AD计算分两个阶段，第一个阶段执行前向AD以计算中间变量导数并记录计算图中的依赖关系，第二个阶段通过将伴随变量反向传播回输入来计算所有导数。 如下图：<center><img data-src="https://vivounicorn.github.io/images/ad/bp.png" width="600"></center><p>依然以函数<span class="math inline">\(f(x,y,z)=xy\cos(xz)\)</span>在点<span class="math inline">\((-2,3,-6)\)</span>为例，计算每个中间变量：</p><table><colgroup><col style="width:22%"><col style="width:77%"></colgroup><thead><tr class="header"><th>原始问题</th><th style="text-align:left">反向模式</th></tr></thead><tbody><tr class="odd"><td><span class="math inline">\(x=-2\)</span></td><td style="text-align:left"><span class="math inline">\(\overline{x}=\overline{t}\cdot\frac{\partial t}{\partial x}+\overline{u}\cdot\frac{\partial{u}}{\partial{x}}=vy-tz\sin(u)\)</span></td></tr><tr class="even"><td><span class="math inline">\(y=3\)</span></td><td style="text-align:left"><span class="math inline">\(\overline{y}=\overline{t}\cdot\frac{\partial t}{\partial y}=vx\)</span></td></tr><tr class="odd"><td><span class="math inline">\(z=-6\)</span></td><td style="text-align:left"><span class="math inline">\(\overline{z}=\overline{u}\cdot\frac{\partial u}{\partial z}=-tx\sin(u)\)</span></td></tr><tr class="even"><td><span class="math inline">\(t=xy\)</span></td><td style="text-align:left"><span class="math inline">\(\overline{t}=\overline{w}\cdot\frac{\partial w}{\partial t}=v\)</span></td></tr><tr class="odd"><td><span class="math inline">\(u=xz\)</span></td><td style="text-align:left"><span class="math inline">\(\overline{u}=\overline{v}\cdot\frac{\partial v}{\partial u}=-t\sin(u)\)</span></td></tr><tr class="even"><td><span class="math inline">\(v=\cos(u)\)</span></td><td style="text-align:left"><span class="math inline">\(\overline{v}=\overline{w}\cdot\frac{\partial w}{\partial v}=t\)</span></td></tr><tr class="odd"><td><span class="math inline">\(w=tv\)</span></td><td style="text-align:left"><span class="math inline">\(\overline{w}=\frac{\partial {w}}{\partial {w}}=1\)</span></td></tr></tbody></table>计算图如下：<center><img data-src="https://vivounicorn.github.io/images/ad/bpad.png" width="500"></center><p>中间变量和伴随变量计算如下：</p><p><span class="math display">\[ \begin{aligned} \overline{w}&amp;=\frac{\partial {w}}{\partial {w}}=1\\ \overline{v}&amp;=\overline{w}\cdot\frac{\partial w}{\partial v}=t=xy=-6\\ \overline{u}&amp;=\overline{v}\cdot\frac{\partial v}{\partial u}=-t\sin(u)=-xy\sin(xz)=-3.219\\ \overline{t}&amp;=\overline{w}\cdot\frac{\partial w}{\partial t}=v=0.8439\\ \overline{z}&amp;=\overline{u}\cdot\frac{\partial u}{\partial z}=-tx\sin(u)=6.4389\\ \overline{y}&amp;=\overline{t}\cdot\frac{\partial t}{\partial y}=vx=-1.6877\\ \overline{x}&amp;=\overline{t}\cdot\frac{\partial t}{\partial x}+\overline{u}\cdot\frac{\partial{u}}{\partial{x}}=vy-tz\sin(u)=21.8482 \end{aligned} \]</span></p><p>计算机求解以上问题有很多方法，其中一种是利用线性代数求解，如下：</p><p>把上面的中间变量和伴随变量重新整理下，定义变量：<span class="math inline">\(x=[\overline{x},\overline{y},\overline{z},\overline{t},\overline{u},\overline{v},\overline{w}]^T\)</span>： <span class="math display">\[ \begin{aligned} \overline{x}-3\overline{t}+6\overline{u}=0\\ \overline{y}+2\overline{t}=0\\ \overline{z}+2\overline{u}=0\\ \overline{t}-\overline{w}v=0\\ \overline{u}+\overline{v}\sin(u)=0\\ \overline{v}-\overline{w}t=0\\ \overline{w}=1 \end{aligned} \]</span> 令： <span class="math display">\[ \begin{aligned} A&amp;= \left[ \begin{matrix} 1 &amp; 0 &amp; 0 &amp; -3 &amp; 6 &amp; 0 &amp; 0 \\ 0 &amp; 1 &amp; 0 &amp; 2 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 &amp; 0 &amp; 2 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; -v \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; \sin(u) &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; -t \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\ \end{matrix} \right]\\ \\ &amp;= \left[ \begin{matrix} 1 &amp; 0 &amp; 0 &amp; -3 &amp; 6 &amp; 0 &amp; 0 \\ 0 &amp; 1 &amp; 0 &amp; 2 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 &amp; 0 &amp; 2 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; -0.8439 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; -0.5366 &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 6 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\ \end{matrix} \right]\\ \\ b&amp;=[0,0,0,0,0,0,1]^T \end{aligned} \]</span> 有： <span class="math display">\[ Ax=b \]</span> 显然<span class="math inline">\(A\)</span>是一个稀疏的上三角矩阵，且对角线所有元素<span class="math inline">\(a_{ij}\neq 0\)</span>，根据Back Substitution回代定理可知，以上式子有唯一解。</p><h3 id="反向ad代码实践">反向AD代码实践</h3><p><strong>1、Back Substitution求解反向AD</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">back_substitution</span>(<span class="params">A, b</span>):</span></span><br><span class="line">    n = b.shape[<span class="number">0</span>]</span><br><span class="line">    x = np.zeros_like(b)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        x[k] = (b[k] - np.dot(A[k, k + <span class="number">1</span>:n], x[k + <span class="number">1</span>:n])) / A[k, k]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    A = np.array([[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">3</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                  [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">                  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, -math.cos(<span class="number">12</span>)],</span><br><span class="line">                  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, math.sin(<span class="number">12</span>), <span class="number">0</span>],</span><br><span class="line">                  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>],</span><br><span class="line">                  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]])</span><br><span class="line">    b = np.array([<span class="number">0.0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>])</span><br><span class="line">    x = back_substitution(A, b)</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">21.84818692</span> -<span class="number">1.68770792</span>  <span class="number">6.43887502</span>  <span class="number">0.84385396</span> -<span class="number">3.21943751</span> -<span class="number">6.</span></span><br><span class="line">  <span class="number">1.</span>        ]</span><br></pre></td></tr></table></figure><p><strong>2、计算图求解反向AD</strong></p><p>还有一种方式是类似tensorflow计算图的方式求反向AD，以下为代码实践：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputeGraphNode</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    定义计算图节点</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, value=<span class="number">0.0</span>, tag=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        初始化函数</span></span><br><span class="line"><span class="string">        :param value: 计算图节点值</span></span><br><span class="line"><span class="string">        :param tag: 计算图节点名字</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.in_nodes = []  <span class="comment"># input nodes</span></span><br><span class="line">        self.op = <span class="literal">None</span>  <span class="comment"># operator</span></span><br><span class="line">        self.tag = tag  <span class="comment"># node&#x27;s tag</span></span><br><span class="line">        self.fod = []  <span class="comment"># first order derivative</span></span><br><span class="line">        self.val = value  <span class="comment"># node&#x27;s value</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;%s:%s&quot;</span> % (self.tag, self.val)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, ComputeGraphNode):</span><br><span class="line">            next_node = AddOp()(self, other)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(other, <span class="built_in">float</span>):</span><br><span class="line">            node_right = Variable(other, tag=<span class="built_in">str</span>(other))</span><br><span class="line">            next_node = AddOp()(self, node_right)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;type of __add__()\&#x27;s arguments should be \&#x27;ComputeGraphNode\&#x27;.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__radd__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self + other</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, ComputeGraphNode):</span><br><span class="line">            next_node = SubOp()(self, other)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(other, <span class="built_in">float</span>):</span><br><span class="line">            node_right = Variable(other, tag=<span class="built_in">str</span>(other))</span><br><span class="line">            next_node = SubOp()(self, node_right)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;type of __sub__()\&#x27;s arguments should be \&#x27;ComputeGraphNode\&#x27;.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rsub__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span> * self + other</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__mul__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, ComputeGraphNode):</span><br><span class="line">            next_node = MulOp()(self, other)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(other, <span class="built_in">float</span>):</span><br><span class="line">            node_right = Variable(other, tag=<span class="built_in">str</span>(other))</span><br><span class="line">            next_node = MulOp()(self, node_right)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;type of __mul__()\&#x27;s arguments should be \&#x27;ComputeGraphNode\&#x27;.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rmul__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self * other</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__pow__</span>(<span class="params">self, power, modulo=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(power, ComputeGraphNode):</span><br><span class="line">            next_node = PowOp()(self, power)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(power, <span class="built_in">int</span>):</span><br><span class="line">            node_right = Variable(power, tag=<span class="built_in">str</span>(power))</span><br><span class="line">            next_node = PowOp()(self, node_right)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;type of __pow__()\&#x27;s arguments should be \&#x27;ComputeGraphNode\&#x27;.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rpow__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        node_left = Variable(other, tag=<span class="built_in">str</span>(other))</span><br><span class="line">        <span class="keyword">return</span> node_left ** self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__truediv__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, ComputeGraphNode):</span><br><span class="line">            next_node = DivOp()(self, other)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(other, <span class="built_in">float</span>):</span><br><span class="line">            node_right = Variable(other, tag=<span class="built_in">str</span>(other))</span><br><span class="line">            next_node = DivOp()(self, node_right)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;type of __div__()\&#x27;s arguments should be \&#x27;ComputeGraphNode\&#x27;.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__rtruediv__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="keyword">return</span> other * self ** (-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cos</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CosOp()(self)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sin</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SinOp()(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Variable</span>(<span class="params">ComputeGraphNode</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    变量类型的计算图节点</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, value, tag=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">        ComputeGraphNode.__init__(self, value, tag=tag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Operator</span>(<span class="params">ABC</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    操作符基类</span></span><br><span class="line"><span class="string">    1、每个节点输入、输出和导数计算出来</span></span><br><span class="line"><span class="string">    2、反向链式法则计算</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        next_node = ComputeGraphNode(tag=<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">1</span>:</span><br><span class="line">            node = args[<span class="number">0</span>]</span><br><span class="line">            next_node.in_nodes = [node]</span><br><span class="line">            next_node.tag = <span class="string">&quot;%s(%s)&quot;</span> % (self.tag, node.tag)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(args) == <span class="number">2</span>:</span><br><span class="line">            node_left, node_right = args[<span class="number">0</span>], args[<span class="number">1</span>]</span><br><span class="line">            next_node.in_nodes = [node_left, node_right]</span><br><span class="line">            next_node.tag = <span class="string">&quot;%s%s%s&quot;</span> % (node_left.tag, self.tag, node_right.tag)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;Operator() takes either 1 or 2 arguments (&#123;&#125; given).&#x27;</span></span><br><span class="line">                            .<span class="built_in">format</span>(<span class="built_in">len</span>(args)))</span><br><span class="line"></span><br><span class="line">        next_node.val = self.forward(next_node)</span><br><span class="line"></span><br><span class="line">        next_node.op = self</span><br><span class="line">        <span class="keyword">return</span> next_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&#x27;forward() must be implemented.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">&#x27;gradient() must be implemented.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddOp</span>(<span class="params">Operator</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27;+&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Operator.__call__(self, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> node.in_nodes[<span class="number">0</span>].val + node.in_nodes[<span class="number">1</span>].val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;node.in_nodes[<span class="number">0</span>]: <span class="number">1.</span>, node.in_nodes[<span class="number">1</span>]: <span class="number">1.</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubOp</span>(<span class="params">Operator</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27;-&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Operator.__call__(self, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> node.in_nodes[<span class="number">0</span>].val - node.in_nodes[<span class="number">1</span>].val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;node.in_nodes[<span class="number">0</span>]: <span class="number">1.</span>, node.in_nodes[<span class="number">1</span>]: -<span class="number">1.</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MulOp</span>(<span class="params">Operator</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27; \cdot &#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Operator.__call__(self, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> node.in_nodes[<span class="number">0</span>].val * node.in_nodes[<span class="number">1</span>].val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;node.in_nodes[<span class="number">0</span>]: node.in_nodes[<span class="number">1</span>].val, node.in_nodes[<span class="number">1</span>]: node.in_nodes[<span class="number">0</span>].val&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DivOp</span>(<span class="params">Operator</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Operator.__call__(self, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> node.in_nodes[<span class="number">0</span>].val / node.in_nodes[<span class="number">1</span>].val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        x = node.in_nodes[<span class="number">0</span>].val</span><br><span class="line">        y = node.in_nodes[<span class="number">1</span>].val</span><br><span class="line">        <span class="keyword">return</span> &#123;node.in_nodes[<span class="number">0</span>]: <span class="number">1.</span> / y, node.in_nodes[<span class="number">1</span>]: -x / y ** <span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CosOp</span>(<span class="params">Operator</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27; \cos &#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Operator.__call__(self, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> math.cos(node.in_nodes[<span class="number">0</span>].val)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;node.in_nodes[<span class="number">0</span>]: -math.sin(node.in_nodes[<span class="number">0</span>].val)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SinOp</span>(<span class="params">Operator</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27; \sin &#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Operator.__call__(self, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> math.sin(node.in_nodes[<span class="number">0</span>].val)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;node.in_nodes[<span class="number">0</span>]: math.cos(node.in_nodes[<span class="number">0</span>].val)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowOp</span>(<span class="params">Operator</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        self.tag = <span class="string">&#x27;^&#x27;</span></span><br><span class="line">        next_node = Operator.__call__(self, *args, **kwargs)</span><br><span class="line">        next_node.tag = <span class="string">&quot;%s%s%s&quot;</span> % (next_node.in_nodes[<span class="number">0</span>].tag, self.tag, next_node.in_nodes[<span class="number">1</span>].tag)</span><br><span class="line">        <span class="keyword">return</span> next_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        <span class="keyword">return</span> node.in_nodes[<span class="number">0</span>].val ** node.in_nodes[<span class="number">1</span>].val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradient</span>(<span class="params">self, node</span>):</span></span><br><span class="line">        x = node.in_nodes[<span class="number">0</span>].val</span><br><span class="line">        y = node.in_nodes[<span class="number">1</span>].val</span><br><span class="line">        <span class="keyword">return</span> &#123;node.in_nodes[<span class="number">0</span>]: y * x ** (y - <span class="number">1</span>), node.in_nodes[<span class="number">1</span>]: x ** y * math.log(x)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecutorTools</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse_order_dfs_sort</span>(<span class="params">compute_node</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(compute_node, ComputeGraphNode):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&#x27;type of reverse_dfs_sort()\&#x27;s arguments should be \&#x27;ComputeGraphNode\&#x27;.&#x27;</span>)</span><br><span class="line">        visited = <span class="built_in">set</span>()</span><br><span class="line">        positive_order_dfs = []</span><br><span class="line">        ExecutorTools.post_order_dfs(compute_node, visited, positive_order_dfs)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">reversed</span>(positive_order_dfs)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post_order_dfs</span>(<span class="params">compute_node, visited, topo_order</span>):</span></span><br><span class="line">        <span class="keyword">if</span> compute_node <span class="keyword">in</span> visited:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        visited.add(compute_node)</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> compute_node.in_nodes:</span><br><span class="line">            ExecutorTools.post_order_dfs(n, visited, topo_order)</span><br><span class="line">        topo_order.append(compute_node)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gradients</span>(<span class="params">compute_node, var_list</span>):</span></span><br><span class="line">        <span class="comment"># 对计算图的节点做dfs，为了方便后续计算反向梯度值，对列表做了逆序排列。</span></span><br><span class="line">        compute_node_grapth = ExecutorTools.reverse_order_dfs_sort(compute_node)</span><br><span class="line">        <span class="comment"># 存储每个节点的反向自动微分值，对应符号$\overline&#123;&#125;$对应的变量， 跟节点梯度值为1。</span></span><br><span class="line">        each_node_grad = &#123;compute_node: <span class="number">1</span>&#125;</span><br><span class="line">        <span class="comment"># 遍历计算图中的每个节点。</span></span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> compute_node_grapth:</span><br><span class="line">            <span class="comment"># 对有操作符的中间节点做反向梯度传播。</span></span><br><span class="line">            <span class="keyword">if</span> node.op <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># 求父节点node的所有输入节点的导数值</span></span><br><span class="line">                input_grads_list = node.op.gradient(node)</span><br><span class="line">                <span class="comment"># 遍历当前节点的所有输入节点。</span></span><br><span class="line">                <span class="keyword">for</span> i_node <span class="keyword">in</span> node.in_nodes:</span><br><span class="line">                    <span class="comment"># 如果一个节点被共用，则梯度需要做累加</span></span><br><span class="line">                    <span class="keyword">if</span> i_node <span class="keyword">in</span> each_node_grad:</span><br><span class="line">                        each_node_grad[i_node] += each_node_grad[node] * input_grads_list[i_node]</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        each_node_grad[i_node] = each_node_grad[node] * input_grads_list[i_node]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># for i in each_node_grad:</span></span><br><span class="line">        <span class="comment">#     print(&quot;%s:%s&quot; % (i.tag, each_node_grad[i]))</span></span><br><span class="line"></span><br><span class="line">        var_grad_list = [each_node_grad[node] <span class="keyword">for</span> node <span class="keyword">in</span> var_list]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> each_node_grad, var_grad_list</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">visualize</span>(<span class="params">cp_nodes</span>):</span></span><br><span class="line">        G = nx.DiGraph()</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> cp_nodes:</span><br><span class="line">            tag_root = <span class="string">&quot;%s:%s&quot;</span> % (node.tag, cp_nodes[node])</span><br><span class="line">            G.add_node(tag_root, attr_dict=&#123;<span class="string">&#x27;color&#x27;</span>: <span class="string">&quot;red&quot;</span>&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(node.in_nodes) == <span class="number">1</span>:</span><br><span class="line">                tag_child = <span class="string">&quot;%s:%s&quot;</span> % (node.in_nodes[<span class="number">0</span>].tag, cp_nodes[node.in_nodes[<span class="number">0</span>]])</span><br><span class="line">                G.add_node(tag_child, color=<span class="string">&quot;red&quot;</span>)</span><br><span class="line">                G.add_edge(tag_child, tag_root)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">len</span>(node.in_nodes) == <span class="number">2</span>:</span><br><span class="line">                tag_left = <span class="string">&quot;%s:%s&quot;</span> % (node.in_nodes[<span class="number">0</span>].tag, cp_nodes[node.in_nodes[<span class="number">0</span>]])</span><br><span class="line">                tag_right = <span class="string">&quot;%s:%s&quot;</span> % (node.in_nodes[<span class="number">1</span>].tag, cp_nodes[node.in_nodes[<span class="number">1</span>]])</span><br><span class="line">                G.add_node(tag_right, color=<span class="string">&quot;red&quot;</span>)</span><br><span class="line">                G.add_edge(tag_right, tag_root)</span><br><span class="line">                G.add_node(tag_left, color=<span class="string">&quot;red&quot;</span>)</span><br><span class="line">                G.add_edge(tag_left, tag_root)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_root_leaves_node</span>(<span class="params">G</span>):</span></span><br><span class="line">            root_node, leaf_nodes = <span class="literal">None</span>, []</span><br><span class="line">            <span class="keyword">for</span> n <span class="keyword">in</span> G.nodes:</span><br><span class="line">                pre_node = G.neighbors(n)</span><br><span class="line">                child_node = G.predecessors(n)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(pre_node)) == <span class="number">0</span>:</span><br><span class="line">                    root_node = n</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(child_node)) == <span class="number">0</span>:</span><br><span class="line">                    leaf_nodes.append(n)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> root_node, leaf_nodes</span><br><span class="line"></span><br><span class="line">        root, leaves = get_root_leaves_node(G)</span><br><span class="line"></span><br><span class="line">        color_map = []</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> G.nodes:</span><br><span class="line">            <span class="keyword">if</span> node == root:</span><br><span class="line">                color_map.append(<span class="string">&#x27;tab:red&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> node <span class="keyword">in</span> leaves:</span><br><span class="line">                color_map.append(<span class="string">&#x27;tab:green&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                color_map.append(<span class="string">&#x27;tab:blue&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        labels = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> G.nodes:</span><br><span class="line">            text = node.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">            label = text[<span class="number">0</span>]</span><br><span class="line">            value = <span class="built_in">str</span>(<span class="built_in">round</span>(<span class="built_in">float</span>(text[<span class="number">1</span>]), <span class="number">2</span>))</span><br><span class="line">            labels[node] = <span class="string">&quot;$%s=%s$&quot;</span> % (label, value)</span><br><span class="line"></span><br><span class="line">        pos = nx.circular_layout(G)</span><br><span class="line">        nx.draw_networkx(G, node_color=color_map, node_size=<span class="number">1000</span>, pos=pos, with_labels=<span class="literal">False</span>)</span><br><span class="line">        nx.draw_networkx_labels(G, pos, labels, font_size=<span class="number">22</span>, font_color=<span class="string">&quot;black&quot;</span>)</span><br><span class="line"></span><br><span class="line">        plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    x = Variable(-<span class="number">2</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">    y = Variable(<span class="number">3</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">    z = Variable(-<span class="number">6</span>, <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">    f = x * y * ComputeGraphNode.cos(x * z)</span><br><span class="line"></span><br><span class="line">    nodes, gradients = ExecutorTools.gradients(f, [x, y, z])</span><br><span class="line">    <span class="built_in">print</span>(gradients)</span><br><span class="line">    ExecutorTools.visualize(nodes)</span><br><span class="line"></span><br></pre></td></tr></table></figure><center><img data-src="https://vivounicorn.github.io/images/ad/rad.png" width="800"></center><p>以上代码均可在 <strong><a target="_blank" rel="noopener" href="https://github.com/vivounicorn/automatic_differentiation">这里</a></strong> 下载。</p><h2 id="总结">总结</h2><p>自动微分是目前所有主流机器学习框架的根基之一，而前向模式AD和反向模式AD又是求解自动微分的两类核心方法，本质上，对多元函数<span class="math inline">\(f:\mathbb{R}^n \rightarrow \mathbb{R}^m\)</span>求导，是在求该函数的雅克比矩阵（Jacobi matrix），它是<span class="math inline">\(m×n\)</span>的矩阵，所以显然，当<span class="math inline">\(n\ll m\)</span>，即输入维度远小于输出维度时，此时进行<span class="math inline">\(n\)</span>次前向模式AD得到雅克比矩阵的计算代价比较低，反之，则使用反向模式AD更合适。在机器学习问题中，往往输入变量的维度远远大于输出，所以反向模式AD几乎是各大计算框架的唯一选择。</p><h2 id="参考文献">参考文献</h2><p>《<a target="_blank" rel="noopener" href="https://www.redalyc.org/journal/467/46761359006/html/#redalyc_46761359006_ref33">Dual Numbers for Algorithmic Differentiation</a>》</p><p>《<a target="_blank" rel="noopener" href="https://londmathsoc.onlinelibrary.wiley.com/doi/10.1112/plms/s1-4.1.381">Preliminary sketch of biquaternions</a>》</p><p>《<a target="_blank" rel="noopener" href="http://www.ams.org/publicoutreach/feature-column/fc-2017-12">How to Differentiate with a Computer</a>》</p></div><div class="popular-posts-header">相关文章推荐</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/article/d677b2e0.html" rel="bookmark">机器学习与人工智能技术分享-第三章 机器学习中的统一框架</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/article/ad2261a2.html" rel="bookmark">机器学习与人工智能技术分享-第四章 最优化原理</a></div></li></ul><div class="followme"><p>欢迎关注我的其它发布渠道</p><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="https://vivounicorn.github.io/images/image_1ben4gmqc1l38cpd11e61b97uvs9.png"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag"># 机器学习</a> <a href="/tags/%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86/" rel="tag"># 自动微分</a> <a href="/tags/Automatic-Differentiation/" rel="tag"># Automatic Differentiation</a></div><div class="post-nav"><div class="post-nav-item"><a href="/article/c0a9d987.html" rel="prev" title="机器学习与人工智能技术分享-第十章-Vision Transformers (ViT)"><i class="fa fa-chevron-left"></i> 机器学习与人工智能技术分享-第十章-Vision Transformers (ViT)</a></div><div class="post-nav-item"><a href="/article/d0a635cc.html" rel="next" title="0-1规划及其现实应用(0-1 Programming)">0-1规划及其现实应用(0-1 Programming) <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener("tabs:register",()=>{let e=CONFIG.comments["activeClass"];if(CONFIG.comments.storage&&(e=localStorage.getItem("comments_active")||e),e){let t=document.querySelector(`a[href="#comment-${e}"]`);t&&t.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{t.target.matches(".tabs-comment .tab-content .tab-pane")&&(t=t.target.classList[1],localStorage.setItem("comments_active",t))})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86"><span class="nav-text">机器学习中的自动微分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%B7%A5%E6%B1%82%E8%A7%A3"><span class="nav-text">手工求解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E5%80%BC%E5%BE%AE%E5%88%86"><span class="nav-text">数值微分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E5%BE%AE%E5%88%86"><span class="nav-text">符号微分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86ad"><span class="nav-text">自动微分(AD)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%81%E9%97%AD%E8%A1%A8%E8%BE%BE%E5%BC%8Fclosed-form-expressions"><span class="nav-text">封闭表达式(Closed-Form Expressions)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E5%81%B6%E6%95%B0"><span class="nav-text">对偶数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%90%91%E6%A8%A1%E5%BC%8F%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86forward-mode-ad"><span class="nav-text">前向模式自动微分(Forward mode AD)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%90%91ad%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5"><span class="nav-text">前向AD代码实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%90%91%E6%A8%A1%E5%BC%8F%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86reverse-mode-ad"><span class="nav-text">反向模式自动微分(Reverse mode AD)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%90%91ad%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5"><span class="nav-text">反向AD代码实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">参考文献</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="张磊" src="https://vivounicorn.github.io/images/wali.png"><p class="site-author-name" itemprop="name">张磊</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">51</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="sidebar-button motion-element"><i class="fa fa-comment"></i> Chat</div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/vivounicorn" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;vivounicorn" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:zhangleisuper@gmail.com" title="E-Mail → mailto:zhangleisuper@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://weibo.com/vivounicorn" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;vivounicorn" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title recent-posts-title"><i class="fa fa-history" aria-hidden="true"></i> Recently</div><ul class="links-of-blogroll-list recent-posts-list"><li class="my-links-of-blogroll-item"><a href="/article/fe514cfb.html" title="BERTopic主题模型详解" target="">BERTopic主题模型详解</a></li><li class="my-links-of-blogroll-item"><a href="/article/d0a635cc.html" title="0-1规划及其现实应用(0-1 Programming)" target="">0-1规划及其现实应用(0-1 Programming)</a></li><li class="my-links-of-blogroll-item"><a href="/article/1b1480ce.html" title="机器学习中的自动微分(Automatic Differentiation)" target="">机器学习中的自动微分(Automatic Differentiation)</a></li><li class="my-links-of-blogroll-item"><a href="/article/c0a9d987.html" title="机器学习与人工智能技术分享-第十章-Vision Transformers (ViT)" target="">机器学习与人工智能技术分享-第十章-Vision Transformers (ViT)</a></li><li class="my-links-of-blogroll-item"><a href="/article/ecf91ad8.html" title="有趣的微积分" target="">有趣的微积分</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2022027092号-1</a></div><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">张磊</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">580k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">8:47</span></div></div></footer></div><script src="//cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script><script src="//cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script>!function(){var e,t,o,n,r=document.getElementsByTagName("link");if(0<r.length)for(i=0;i<r.length;i++)"canonical"==r[i].rel.toLowerCase()&&r[i].href&&(e=r[i].href);t=(e||window.location.protocol).split(":")[0],e=e||window.location.href,window,o=e,n=document.referrer,/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(o)||(t="https"===String(t).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif",n?(t+="?r="+encodeURIComponent(document.referrer),o&&(t+="&l="+o)):o&&(t+="?l="+o),(new Image).src=t)}()</script><script src="/js/local-search.js"></script><script>"undefined"==typeof MathJax?(window.MathJax={loader:{load:["[tex]/mhchem"],source:{"[tex]/amsCd":"[tex]/amscd","[tex]/AMScd":"[tex]/amscd"}},tex:{inlineMath:{"[+]":[["$","$"]]},packages:{"[+]":["mhchem"]},tags:"ams"},options:{renderActions:{findScript:[10,d=>{document.querySelectorAll('script[type^="math/tex"]').forEach(e=>{var t=!!e.type.match(/; *mode=display/);const a=new d.options.MathItem(e.textContent,d.inputJax[0],t);t=document.createTextNode("");e.parentNode.replaceChild(t,e),a.start={node:t,delim:"",n:0},a.end={node:t,delim:"",n:0},d.math.push(a)})},"",!1],insertedScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(e=>{let t=e.parentNode;"li"===t.nodeName.toLowerCase()&&t.parentNode.classList.add("has-jax")})},"",!1]}}},function(){var e=document.createElement("script");e.src="//cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.5/es5/tex-mml-chtml.js",e.defer=!0,document.head.appendChild(e)}()):(MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset())</script><script>NexT.utils.loadComments(document.querySelector("#valine-comments"),()=>{NexT.utils.getScript("//cdnjs.cloudflare.com/ajax/libs/valine/1.3.10/Valine.min.js",()=>{var i=["nick","mail","link"],e="nick,mail,link".split(",").filter(e=>i.includes(e));new Valine({el:"#valine-comments",verify:!1,notify:!0,appId:"m8FPP0CqMpxyTuUvaVOX9qVV-gzGzoHsz",appKey:"Ori6X9PXqQyURvwgl7HT5TJj",placeholder:"赠人玫瑰，手有余香",avatar:"mm",meta:e,pageSize:"10",visitor:!0,lang:"zh-cn",path:location.pathname,recordIP:!1,serverURLs:""})},window.Valine)})</script></body></html>